<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Console - System Cards</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #00854A;
      --primary-dark: #006838;
      --primary-light: #e6f5ed;
      --bg-light: #f8fafc;
      --bg-white: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border-color: #e2e8f0;
      --success: #16a34a;
      --success-light: #dcfce7;
      --warning: #ca8a04;
      --warning-light: #fef9c3;
      --error: #dc2626;
      --error-light: #fee2e2;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-light);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }
    
    .container { max-width: 1100px; margin: 0 auto; padding: 32px 20px; }
    
    .header { text-align: center; margin-bottom: 32px; }
    
    .admin-badge {
      display: inline-block; padding: 6px 16px;
      background: var(--error-light); border: 1px solid var(--error);
      border-radius: 100px; font-size: 12px; color: var(--error); 
      font-weight: 600; margin-bottom: 12px; text-transform: uppercase;
    }
    
    .event-title {
      font-size: clamp(18px, 3vw, 24px); font-weight: 800;
      color: var(--primary); margin-bottom: 8px;
    }
    
    .page-title {
      font-size: clamp(24px, 4vw, 32px); font-weight: 800;
      color: var(--text-primary);
    }
    
    /* Login */
    .login-card {
      background: var(--bg-white); border: 1px solid var(--border-color);
      border-radius: 16px; padding: 32px; max-width: 400px; margin: 60px auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .login-title { font-size: 20px; font-weight: 700; margin-bottom: 20px; text-align: center; }
    
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500; }
    
    .form-input, .form-textarea {
      width: 100%; padding: 12px 14px; background: var(--bg-white);
      border: 1px solid var(--border-color); border-radius: 8px;
      font-size: 15px; font-family: inherit;
    }
    
    .form-textarea { resize: vertical; min-height: 80px; }
    
    .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--primary); }
    
    .btn {
      width: 100%; padding: 14px; border: none; border-radius: 8px;
      font-size: 15px; font-weight: 600; cursor: pointer;
      background: var(--primary); color: white;
      transition: background 0.2s;
    }
    
    .btn:hover { background: var(--primary-dark); }
    
    .error-msg { color: var(--error); font-size: 14px; margin-top: 12px; text-align: center; }
    
    /* Admin Panel */
    .admin-panel { display: none; }
    .admin-panel.active { display: block; }
    
    .stats-row {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px; margin-bottom: 24px;
    }
    
    .stat-card {
      background: var(--bg-white); border: 1px solid var(--border-color);
      border-radius: 12px; padding: 20px; text-align: center;
    }
    
    .stat-value { font-size: 28px; font-weight: 800; color: var(--primary); }
    .stat-label { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }
    
    .stat-card.green .stat-value { color: var(--success); }
    .stat-card.yellow .stat-value { color: var(--warning); }
    .stat-card.red .stat-value { color: var(--error); }
    
    .card {
      background: var(--bg-white); border: 1px solid var(--border-color);
      border-radius: 16px; padding: 24px; margin-bottom: 16px;
    }
    
    .card-title {
      font-size: 18px; font-weight: 700; margin-bottom: 16px;
      display: flex; align-items: center; gap: 10px;
    }
    
    .filters {
      display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;
      align-items: center;
    }
    
    .search-input { flex: 1; min-width: 200px; padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 8px; }
    
    .filter-btn {
      padding: 10px 16px; border: 1px solid var(--border-color); border-radius: 8px;
      background: var(--bg-white); cursor: pointer; font-size: 14px;
      transition: all 0.2s;
    }
    
    .filter-btn:hover { border-color: var(--primary); }
    .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    
    /* Entity Row */
    .entity-row {
      display: flex; align-items: center; padding: 16px;
      border-bottom: 1px solid var(--border-color);
      gap: 16px;
    }
    
    .entity-row:last-child { border-bottom: none; }
    
    .entity-info { flex: 1; min-width: 150px; }
    .entity-name { font-weight: 600; font-size: 15px; }
    .entity-country { font-size: 13px; color: var(--text-muted); }
    
    .entity-cards { flex: 2; }
    
    .card-badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 12px; border-radius: 6px; font-size: 12px;
      margin-right: 8px; margin-bottom: 6px; cursor: pointer;
      transition: all 0.2s;
    }
    
    .card-badge:hover { opacity: 0.8; }
    .card-badge.pending { background: var(--warning-light); color: var(--warning); }
    .card-badge.validated { background: var(--success-light); color: var(--success); }
    .card-badge.refused { background: var(--error-light); color: var(--error); }
    .card-badge.none { background: var(--bg-light); color: var(--text-muted); }
    
    .entity-status { width: 120px; text-align: center; }
    
    .status-indicator {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500;
    }
    
    .status-indicator.green { background: var(--success-light); color: var(--success); }
    .status-indicator.yellow { background: var(--warning-light); color: var(--warning); }
    .status-indicator.red { background: var(--error-light); color: var(--error); }
    
    /* Cards Modal */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
      padding: 20px;
    }
    
    .modal-overlay.active { display: flex; }
    
    .modal {
      background: white; border-radius: 16px; padding: 24px; max-width: 700px;
      width: 100%; max-height: 80vh; overflow-y: auto;
    }
    
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title { font-size: 18px; font-weight: 700; }
    .modal-close { cursor: pointer; font-size: 24px; color: var(--text-muted); background: none; border: none; }
    
    .card-row {
      padding: 16px; background: var(--bg-light); border-radius: 10px;
      margin-bottom: 12px;
    }
    
    .card-row-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .card-row-info { display: flex; align-items: center; gap: 12px; }
    .card-row-name { font-weight: 600; font-size: 15px; }
    .card-row-date { font-size: 12px; color: var(--text-muted); }
    
    .card-row-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    
    .btn-action {
      padding: 8px 14px; border-radius: 6px; cursor: pointer; border: none;
      font-size: 13px; font-weight: 500; transition: all 0.2s;
    }
    
    .btn-view { background: var(--primary-light); color: var(--primary); }
    .btn-view:hover { background: var(--primary); color: white; }
    
    .btn-validate { background: var(--success-light); color: var(--success); }
    .btn-validate:hover { background: var(--success); color: white; }
    
    .btn-pending { background: var(--warning-light); color: var(--warning); }
    .btn-pending:hover { background: var(--warning); color: white; }
    
    .btn-refuse { background: var(--error-light); color: var(--error); }
    .btn-refuse:hover { background: var(--error); color: white; }
    
    .refuse-form {
      margin-top: 12px; padding: 12px; background: var(--error-light);
      border-radius: 8px; display: none;
    }
    
    .refuse-form.active { display: block; }
    
    .refuse-form label { font-size: 13px; font-weight: 500; color: var(--error); display: block; margin-bottom: 6px; }
    
    .refuse-form textarea {
      width: 100%; padding: 10px; border: 1px solid var(--error); border-radius: 6px;
      font-size: 14px; font-family: inherit; resize: vertical; min-height: 60px;
    }
    
    .refuse-form-buttons { display: flex; gap: 8px; margin-top: 10px; }
    
    .btn-confirm-refuse {
      background: var(--error-light); color: var(--error); 
      border: 2px solid var(--error); padding: 8px 14px; border-radius: 6px;
      cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;
    }
    .btn-confirm-refuse:hover { background: var(--error); color: white; }
    
    .current-status {
      padding: 8px 12px; border-radius: 6px; font-size: 13px; margin-top: 8px;
    }
    
    .current-status.validated { background: var(--success-light); color: var(--success); }
    .current-status.pending { background: var(--warning-light); color: var(--warning); }
    .current-status.refused { background: var(--error-light); color: var(--error); }
    
    /* Responsive */
    @media (max-width: 768px) {
      .entity-row { flex-wrap: wrap; }
      .entity-cards { width: 100%; margin: 10px 0; }
      .entity-status { width: auto; }
      .stats-row { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Form -->
    <div id="login-section">
      <div class="login-card">
        <div class="login-title">üîê Admin Login</div>
        <div class="form-group">
          <label class="form-label">Event</label>
          <input type="text" id="event-display" class="form-input" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" id="password-input" class="form-input" placeholder="Enter admin password">
        </div>
        <button class="btn" onclick="login()">Login</button>
        <div id="login-error" class="error-msg" style="display: none;"></div>
      </div>
    </div>
    
    <!-- Admin Panel -->
    <div id="admin-panel" class="admin-panel">
      <div class="header">
        <div class="admin-badge">üîê Admin Console</div>
        <div class="event-title" id="event-title"></div>
        <h1 class="page-title">System Cards Validation</h1>
      </div>
      
      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-label">Total Teams</div>
        </div>
        <div class="stat-card green">
          <div class="stat-value" id="stat-complete">0</div>
          <div class="stat-label">Complete ‚úì</div>
        </div>
        <div class="stat-card yellow">
          <div class="stat-value" id="stat-pending">0</div>
          <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card red">
          <div class="stat-value" id="stat-nocards">0</div>
          <div class="stat-label">No Cards</div>
        </div>
        <div class="stat-card red">
          <div class="stat-value" id="stat-refused">0</div>
          <div class="stat-label">Refused</div>
        </div>
      </div>
      
      <!-- Entities List -->
      <div class="card">
        <div class="card-title">üìã All Entries</div>
        
        <div class="filters">
          <input type="text" id="search-input" class="search-input" placeholder="üîç Search..." oninput="filterEntities()">
          <button class="filter-btn active" onclick="setFilter('all')">All</button>
          <button class="filter-btn" onclick="setFilter('complete')">Complete</button>
          <button class="filter-btn" onclick="setFilter('pending')">Pending</button>
          <button class="filter-btn" onclick="setFilter('nocards')">No Cards</button>
          <button class="filter-btn" onclick="setFilter('refused')">Refused</button>
        </div>
        
        <div id="entities-list"></div>
      </div>
    </div>
  </div>
  
  <!-- Cards Modal -->
  <div class="modal-overlay" id="cards-modal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modal-entity-name"></div>
        <button class="modal-close" onclick="closeCardsModal()">√ó</button>
      </div>
      <div id="modal-cards-list"></div>
    </div>
  </div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const urlParams = new URLSearchParams(window.location.search);
const tournamentCode = urlParams.get('tournament') || '26prague';
const eventFilter = urlParams.get('event') || '';

const EVENT_CONFIG = {
  'Winter Open Teams': { type: 'teams', title: 'EUROPEAN WINTER OPEN TEAMS CHAMPIONSHIP' },
  'Winter Swiss Cup': { type: 'teams', title: 'EUROPEAN WINTER SWISS CUP' },
  'Winter Mixed Teams': { type: 'teams', title: 'EUROPEAN WINTER MIXED TEAMS CHAMPIONSHIP' },
  'Winter Open BAM': { type: 'teams', title: 'EUROPEAN WINTER OPEN BAM' },
  'Winter Open Pairs': { type: 'pairs', title: 'EUROPEAN WINTER OPEN PAIRS' },
  'Winter Mixed Pairs': { type: 'pairs', title: 'EUROPEAN WINTER MIXED PAIRS' },
};

const CONFIG = {
  tournamentCode,
  eventFilter,
  eventType: EVENT_CONFIG[eventFilter]?.type || 'teams',
  eventTitle: EVENT_CONFIG[eventFilter]?.title || eventFilter,
  apiEndpoint: window.location.origin + "/api",
};

document.getElementById('event-display').value = CONFIG.eventTitle;

// ============================================
// STATE
// ============================================
let isLoggedIn = false;
let entities = [];
let uploadedCards = [];
let validationStatus = {};
let currentFilter = 'all';
let currentModalEntity = null;

// ============================================
// LOGIN
// ============================================
async function login() {
  const password = document.getElementById('password-input').value;
  const errorDiv = document.getElementById('login-error');
  
  try {
    const response = await fetch(`${CONFIG.apiEndpoint}/admin-login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        tournament: CONFIG.tournamentCode,
        event: CONFIG.eventFilter,
        password
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      isLoggedIn = true;
      sessionStorage.setItem('adminToken', data.token);
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('admin-panel').classList.add('active');
      document.getElementById('event-title').textContent = CONFIG.eventTitle;
      await loadData();
    } else {
      errorDiv.textContent = 'Invalid password';
      errorDiv.style.display = 'block';
    }
  } catch (error) {
    errorDiv.textContent = 'Login failed. Please try again.';
    errorDiv.style.display = 'block';
  }
}

// ============================================
// DATA LOADING
// ============================================
async function loadData() {
  await Promise.all([
    loadEntities(),
    loadUploadedCards(),
    loadValidationStatus()
  ]);
  updateStats();
  renderEntitiesList();
}

async function loadEntities() {
  try {
    const endpoint = CONFIG.eventType === 'pairs' ? 'pairs' : 'teams';
    const response = await fetch(`${CONFIG.apiEndpoint}/${endpoint}?tournament=${CONFIG.tournamentCode}`);
    const data = await response.json();
    entities = data[endpoint] || data.teams || data.pairs || [];
    
    if (CONFIG.eventFilter) {
      entities = entities.filter(e => e.event === CONFIG.eventFilter);
    }
  } catch (error) {
    console.error('Failed to load entities:', error);
  }
}

async function loadUploadedCards() {
  try {
    const response = await fetch(`${CONFIG.apiEndpoint}/cards?tournament=${CONFIG.tournamentCode}`);
    const data = await response.json();
    uploadedCards = data.cards || [];
  } catch (error) {
    console.error('Failed to load cards:', error);
  }
}

async function loadValidationStatus() {
  try {
    const token = sessionStorage.getItem('adminToken');
    const response = await fetch(
      `${CONFIG.apiEndpoint}/admin-data?tournament=${CONFIG.tournamentCode}&event=${encodeURIComponent(CONFIG.eventFilter)}`,
      { headers: { 'Authorization': `Bearer ${token}` } }
    );
    if (response.ok) {
      const data = await response.json();
      validationStatus = data.validationStatus || {};
    }
  } catch (error) {
    console.log('Could not load validation status');
  }
}

// ============================================
// STATS
// ============================================
function updateStats() {
  const total = entities.length;
  let complete = 0;
  let pending = 0;
  let nocards = 0;
  let refused = 0;
  
  entities.forEach(entity => {
    const status = getEntityStatusInfo(entity);
    if (status.color === 'green') complete++;
    else if (status.color === 'yellow') pending++;
    else if (status.hasRefused) refused++;
    else nocards++;
  });
  
  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-complete').textContent = complete;
  document.getElementById('stat-pending').textContent = pending;
  document.getElementById('stat-nocards').textContent = nocards;
  document.getElementById('stat-refused').textContent = refused;
}

// ============================================
// RENDERING
// ============================================
function renderEntitiesList() {
  const container = document.getElementById('entities-list');
  
  let filtered = entities.filter(entity => {
    const status = getEntityStatusInfo(entity);
    
    if (currentFilter === 'complete') return status.color === 'green';
    if (currentFilter === 'pending') return status.color === 'yellow';
    if (currentFilter === 'nocards') return status.color === 'red' && !status.hasRefused;
    if (currentFilter === 'refused') return status.hasRefused;
    return true;
  });
  
  // Apply search
  const searchTerm = document.getElementById('search-input').value.toLowerCase();
  if (searchTerm) {
    filtered = filtered.filter(e => e.name.toLowerCase().includes(searchTerm));
  }
  
  container.innerHTML = filtered.map(entity => {
    const cards = getCardsForEntity(entity);
    const status = getEntityStatusInfo(entity);
    
    return `
      <div class="entity-row">
        <div class="entity-info">
          <div class="entity-name">${entity.name}</div>
          ${entity.country ? `<div class="entity-country">${entity.country}</div>` : ''}
        </div>
        <div class="entity-cards">
          ${cards.length > 0 ? cards.map(card => {
            const cardStatus = getCardStatusInfo(card.fileName);
            const players = getPlayersFromFileName(card.fileName, entity);
            return `<span class="card-badge ${cardStatus.class}" onclick="openCardsModal('${entity.id}')">${players}: ${cardStatus.icon}</span>`;
          }).join('') : '<span class="card-badge none">No cards uploaded</span>'}
        </div>
        <div class="entity-status">
          <span class="status-indicator ${status.color}">${status.text}</span>
        </div>
      </div>
    `;
  }).join('');
}

function getCardsForEntity(entity) {
  const entityNameSanitized = sanitize(entity.name);
  return uploadedCards.filter(card => {
    const cardEntityName = card.fileName.split('_')[0];
    return cardEntityName === entityNameSanitized;
  });
}

function getCardStatusInfo(fileName) {
  const status = validationStatus[fileName];
  
  if (!status || status === 'pending') {
    return { class: 'pending', icon: '‚è≥', label: 'Pending' };
  } else if (status === 'validated') {
    return { class: 'validated', icon: '‚úì', label: 'Validated' };
  } else if (typeof status === 'object' && status.status === 'refused') {
    return { class: 'refused', icon: '‚úó', label: 'Refused', reason: status.reason };
  }
  
  return { class: 'pending', icon: '‚è≥', label: 'Pending' };
}

function getEntityStatusInfo(entity) {
  const cards = getCardsForEntity(entity);
  const playablePlayers = entity.players.filter(p => !isCoachOrCaptain(p));
  
  // Check for refused cards
  const hasRefused = cards.some(card => {
    const status = validationStatus[card.fileName];
    return typeof status === 'object' && status.status === 'refused';
  });
  
  if (hasRefused) {
    return { color: 'red', text: 'Refused', hasRefused: true };
  }
  
  if (cards.length === 0) {
    return { color: 'red', text: 'No cards', hasRefused: false };
  }
  
  // Check coverage
  const playersWithCards = new Set();
  cards.forEach(card => {
    const surnames = card.fileName.replace('.pdf', '').split('_').slice(1);
    surnames.forEach(surname => {
      playablePlayers.forEach(player => {
        if (sanitize(player.surname) === surname) {
          playersWithCards.add(player.wbfId || player.surname);
        }
      });
    });
  });
  
  const allPlayersHaveCards = playablePlayers.every(p => 
    playersWithCards.has(p.wbfId || p.surname)
  );
  
  const allValidated = cards.every(card => validationStatus[card.fileName] === 'validated');
  
  if (allPlayersHaveCards && allValidated) {
    return { color: 'green', text: 'Complete', hasRefused: false };
  }
  
  return { color: 'yellow', text: 'Pending', hasRefused: false };
}

function isCoachOrCaptain(player) {
  const name = player.fullName.toLowerCase();
  const role = (player.role || '').toLowerCase();
  return role.includes('coach') || role.includes('captain') || 
         name.includes('(coach)') || name.includes('(captain)') ||
         name.includes('(npc)') || role.includes('npc');
}

function getPlayersFromFileName(fileName, entity) {
  const parts = fileName.replace('.pdf', '').split('_');
  if (parts.length >= 3) {
    const surnames = parts.slice(1);
    const fullNames = surnames.map(surname => {
      const player = entity.players.find(p => sanitize(p.surname) === surname);
      return player ? player.fullName : surname;
    });
    return fullNames.join(' & ');
  }
  return fileName;
}

function sanitize(str) {
  return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-zA-Z0-9_]/g, '').toUpperCase();
}

// ============================================
// FILTERS
// ============================================
function setFilter(filter) {
  currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`[onclick="setFilter('${filter}')"]`).classList.add('active');
  renderEntitiesList();
}

function filterEntities() {
  renderEntitiesList();
}

// ============================================
// CARDS MODAL
// ============================================
function openCardsModal(entityId) {
  const entity = entities.find(e => e.id === entityId);
  if (!entity) return;
  
  currentModalEntity = entity;
  const cards = getCardsForEntity(entity);
  
  document.getElementById('modal-entity-name').textContent = entity.name;
  document.getElementById('modal-cards-list').innerHTML = cards.map((card, index) => {
    const statusInfo = getCardStatusInfo(card.fileName);
    const players = getPlayersFromFileName(card.fileName, entity);
    
    return `
      <div class="card-row" id="card-row-${index}">
        <div class="card-row-header">
          <div class="card-row-info">
            <span>üìÑ</span>
            <div>
              <div class="card-row-name">${players}</div>
              <div class="card-row-date">Uploaded: ${formatDate(card.lastModified)}</div>
            </div>
          </div>
          <div class="card-row-actions">
            <a href="${card.url}" target="_blank" class="btn-action btn-view">View PDF</a>
          </div>
        </div>
        
        <div class="current-status ${statusInfo.class}">
          Current status: <strong>${statusInfo.label}</strong>
          ${statusInfo.reason ? `<br>Reason: ${statusInfo.reason}` : ''}
        </div>
        
        <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
          <button class="btn-action btn-validate" onclick="setValidation('${card.fileName}', 'validated', ${index})">‚úì Validate</button>
          <button class="btn-action btn-pending" onclick="setValidation('${card.fileName}', 'pending', ${index})">‚è≥ Set Pending</button>
          <button class="btn-action btn-refuse" onclick="showRefuseForm(${index})">‚úó Refuse</button>
        </div>
        
        <div class="refuse-form" id="refuse-form-${index}">
          <label>Reason for refusal:</label>
          <textarea id="refuse-reason-${index}" placeholder="Enter the reason why this card is refused..."></textarea>
          <div class="refuse-form-buttons">
            <button class="btn-confirm-refuse" onclick="submitRefusal('${card.fileName}', ${index})">‚ö†Ô∏è Confirm Refusal</button>
            <button class="btn-action" style="background: var(--bg-light);" onclick="hideRefuseForm(${index})">Cancel</button>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  document.getElementById('cards-modal').classList.add('active');
}

function closeCardsModal() {
  document.getElementById('cards-modal').classList.remove('active');
  currentModalEntity = null;
}

function showRefuseForm(index) {
  document.getElementById(`refuse-form-${index}`).classList.add('active');
}

function hideRefuseForm(index) {
  document.getElementById(`refuse-form-${index}`).classList.remove('active');
}

function formatDate(dateString) {
  if (!dateString) return 'Unknown';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-GB', {
    day: '2-digit', month: 'short', year: 'numeric',
    hour: '2-digit', minute: '2-digit'
  });
}

// ============================================
// API ACTIONS
// ============================================
async function setValidation(fileName, status, index) {
  const token = sessionStorage.getItem('adminToken');
  
  try {
    const response = await fetch(`${CONFIG.apiEndpoint}/admin-validate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        tournament: CONFIG.tournamentCode,
        event: CONFIG.eventFilter,
        fileName,
        status
      })
    });
    
    if (response.ok) {
      validationStatus[fileName] = status;
      updateStats();
      renderEntitiesList();
      if (currentModalEntity) {
        openCardsModal(currentModalEntity.id);
      }
    }
  } catch (error) {
    console.error('Failed to update validation:', error);
    alert('Failed to update. Please try again.');
  }
}

async function submitRefusal(fileName, index) {
  const reason = document.getElementById(`refuse-reason-${index}`).value.trim();
  
  if (!reason) {
    alert('Please enter a reason for the refusal.');
    return;
  }
  
  const token = sessionStorage.getItem('adminToken');
  
  try {
    const response = await fetch(`${CONFIG.apiEndpoint}/admin-validate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        tournament: CONFIG.tournamentCode,
        event: CONFIG.eventFilter,
        fileName,
        status: { status: 'refused', reason }
      })
    });
    
    if (response.ok) {
      validationStatus[fileName] = { status: 'refused', reason };
      updateStats();
      renderEntitiesList();
      if (currentModalEntity) {
        openCardsModal(currentModalEntity.id);
      }
    }
  } catch (error) {
    console.error('Failed to update validation:', error);
    alert('Failed to update. Please try again.');
  }
}
</script>
</body>
</html>
